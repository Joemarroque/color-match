<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Color Match</title>
  <style>
    body {
      background: #222;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      padding: 20px;
      gap: 20px;
    }
    .sidebar {
      width: 250px;
      background: #333;
      padding: 15px;
      border-radius: 8px;
    }
    .main {
      flex-grow: 1;
    }
    #playerNameInput {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: none;
    }
    button {
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background: #008CBA;
      color: white;
      width: 100%;
      margin-bottom: 10px;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 60px);
      gap: 10px;
      margin-top: 20px;
    }
    .tile {
      width: 60px;
      height: 60px;
      background: #444;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }
    .tile.revealed {
      cursor: default;
      box-shadow: 0 0 10px 2px white;
    }
    .orb {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: gray;
      margin-top: 10px;
      box-shadow: none;
      transition: box-shadow 2.5s ease;
    }
    .glow-1 {
      background: lightblue;
      box-shadow: 0 0 10px lightblue;
    }
    .glow-2 {
      background: cyan;
      box-shadow: 0 0 15px cyan;
    }
    .glow-3 {
      background: lime;
      box-shadow: 0 0 20px lime;
    }
    #leaderboard {
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
    }
    .entry {
      padding: 4px 0;
    }
    .highlight {
      font-weight: bold;
      color: yellow;
    }
  </style>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
</head>
<body>
  <div class="sidebar">
    <input id="playerNameInput" maxlength="12" placeholder="Enter your name..." />
    <button id="startGameBtn" disabled>Play</button>
    <div id="score">Score: 0</div>
    <div class="orb" id="orb"></div>
    <div id="leaderboard"><strong>Leaderboard</strong></div>
  </div>

  <div class="main">
    <h2>Color Match</h2>
    <div id="turns">Turns left: 10</div>
    <div class="grid" id="gameGrid"></div>
    <button id="continueBtn" style="display:none;">Continue</button>
    <button id="retryBtn" style="display:none;">Retry</button>
  </div>

  <script>
    // Firebase setup
    const firebaseConfig = {
      apiKey: "AIzaSyA0cWK1uSrL6RdJM7ZD72-buLoh8Yoj2ik",
      authDomain: "match-color-778e0.firebaseapp.com",
      databaseURL: "https://match-color-778e0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "match-color-778e0",
      storageBucket: "match-color-778e0.appspot.com",
      messagingSenderId: "377488439379",
      appId: "1:377488439379:web:7cc6c74cd528fa08b22ea6",
      measurementId: "G-57VFQSTKLP"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Elements
    const playerNameInput = document.getElementById("playerNameInput");
    const startGameBtn = document.getElementById("startGameBtn");
    const gameGrid = document.getElementById("gameGrid");
    const turnsDisplay = document.getElementById("turns");
    const scoreDisplay = document.getElementById("score");
    const orb = document.getElementById("orb");
    const leaderboard = document.getElementById("leaderboard");
    const continueBtn = document.getElementById("continueBtn");
    const retryBtn = document.getElementById("retryBtn");

    // Game data
    const colors = ["red", "blue", "green", "yellow", "orange", "purple", "cyan", "pink"];
    let tiles = [];
    let firstTile = null;
    let secondTile = null;
    let lockBoard = false;
    let remainingTurns = 10;
    let streak = 0;
    let orbCharge = 0;
    let score = 0;
    let gameEnded = true;
    let playerName = "";
    let successfulGames = 0;

    // Enable Play button only when name entered
    playerNameInput.addEventListener("input", () => {
      const val = playerNameInput.value.trim();
      startGameBtn.disabled = val.length === 0;
    });

    startGameBtn.addEventListener("click", () => {
      playerName = playerNameInput.value.trim().slice(0, 12);
      if (!playerName) return;
      gameEnded = false;
      startGameBtn.style.display = "none";
      playerNameInput.disabled = true;
      initGame();
    });

    continueBtn.addEventListener("click", () => {
      const turns = (successfulGames > 0 && successfulGames % 3 === 0) ? 5 : 10;
      restartGame(turns);
    });

    retryBtn.addEventListener("click", () => {
      restartGame(10);
    });

    function initGame() {
      remainingTurns = 10;
      score = 0;
      streak = 0;
      orbCharge = 0;
      updateTurns();
      updateScore();
      updateOrb();
      generateTiles();
      updateLeaderboard();
      continueBtn.style.display = "none";
      retryBtn.style.display = "none";
    }

    function restartGame(turns) {
      remainingTurns = turns;
      streak = 0;
      gameEnded = false;
      updateTurns();
      updateOrb();
      generateTiles();
      continueBtn.style.display = "none";
      retryBtn.style.display = "none";
    }

    function generateTiles() {
      gameGrid.innerHTML = "";
      tiles = [...colors, ...colors].sort(() => Math.random() - 0.5);
      tiles.forEach(color => {
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.style.backgroundColor = "#444";
        tile.dataset.color = color;
        tile.addEventListener("click", () => onTileClick(tile));
        gameGrid.appendChild(tile);
      });
      firstTile = null;
      secondTile = null;
      lockBoard = false;
    }

    function onTileClick(tile) {
      if (lockBoard || tile.classList.contains("revealed") || tile === firstTile || gameEnded || remainingTurns <= 0) return;
      tile.style.backgroundColor = tile.dataset.color;

      if (!firstTile) {
        firstTile = tile;
        return;
      }

      secondTile = tile;
      lockBoard = true;

      if (firstTile.dataset.color === secondTile.dataset.color) {
        firstTile.classList.add("revealed");
        secondTile.classList.add("revealed");
        streak++;
        if (remainingTurns > 5) remainingTurns--;
        updateTurns();
        resetTiles();
        checkWin();
      } else {
        streak = 0;
        remainingTurns--;
        updateTurns();
        setTimeout(() => {
          firstTile.style.backgroundColor = "#444";
          secondTile.style.backgroundColor = "#444";
          resetTiles();
          if (remainingTurns <= 0) {
            endGame(false);
          }
        }, 800);
      }
    }

    function resetTiles() {
      firstTile = null;
      secondTile = null;
      lockBoard = false;
    }

    function updateTurns() {
      turnsDisplay.textContent = `Turns left: ${remainingTurns}`;
    }

    function updateScore() {
      scoreDisplay.textContent = `Score: ${score}`;
    }

    function updateOrb() {
      orb.className = "orb";
      if (orbCharge === 1) orb.classList.add("glow-1");
      else if (orbCharge === 2) orb.classList.add("glow-2");
      else if (orbCharge >= 3) orb.classList.add("glow-3");
    }

    function checkWin() {
      if (document.querySelectorAll(".tile.revealed").length === tiles.length) {
        endGame(true);
      }
    }

    async function saveScoreIfHigher() {
      if (!playerName) return;
      const playerRef = db.ref("players/" + playerName);
      const snapshot = await playerRef.get();
      const existing = snapshot.val();
      if (!existing || score > existing.score) {
        await playerRef.set({
          name: playerName,
          score: score
        });
      }
    }

    function endGame(won) {
      gameEnded = true;
      if (won) {
        successfulGames++;
        orbCharge++;
        if (orbCharge >= 3) {
          score++;
          orbCharge = 0;
        }
        alert("ðŸŽ‰ You won! Click Continue to play next round.");
        continueBtn.style.display = "inline-block";
        retryBtn.style.display = "none";
      } else {
        orbCharge = 0;
        successfulGames = 0;
        alert("Game Over! You ran out of turns.");
        retryBtn.style.display = "inline-block";
        continueBtn.style.display = "none";
      }
      updateOrb();
      updateScore();
      saveScoreIfHigher();
      updateLeaderboard();
    }

    function updateLeaderboard() {
      const playersRef = db.ref("players").orderByChild("score").limitToLast(7);
      playersRef.on("value", snapshot => {
        const data = snapshot.val();
        leaderboard.innerHTML = "<strong>Leaderboard</strong><br>";
        if (!data) {
          leaderboard.innerHTML += "No players yet.";
          return;
        }
        const sortedPlayers = Object.values(data).sort((a,b) => b.score - a.score);
        sortedPlayers.forEach(player => {
          const div = document.createElement("div");
          div.className = "entry";
          if(player.name === playerName) div.classList.add("highlight");
          div.textContent = `${player.name}: ${player.score}`;
          leaderboard.appendChild(div);
        });
      });
    }
  </script>
</body>
</html>

// Import Firebase modular APIs from the loaded SDK (already loaded via <script>)
const { initializeApp } = firebase;
const { getDatabase, ref, query, orderByChild, limitToLast, onValue, get, set, child } = firebase.database;

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA0cWK1uSrL6RdJM7ZD72-buLoh8Yoj2ik",
  authDomain: "match-color-778e0.firebaseapp.com",
  databaseURL: "https://match-color-778e0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "match-color-778e0",
  storageBucket: "match-color-778e0.appspot.com",
  messagingSenderId: "377488439379",
  appId: "1:377488439379:web:7cc6c74cd528fa08b22ea6",
  measurementId: "G-57VFQSTKLP"
};

// Initialize Firebase app and database
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM elements
const gameGrid = document.getElementById("gameGrid");
const turnsDisplay = document.getElementById("turns");
const scoreDisplay = document.getElementById("score");
const orb = document.getElementById("orb");
const leaderboard = document.getElementById("leaderboard");
const continueBtn = document.getElementById("continueGame");
const retryBtn = document.getElementById("retryGame");
const nameInput = document.getElementById("playerNameInput");
const startGameBtn = document.getElementById("startGame");
const namePrompt = document.getElementById("namePrompt");

const colors = ["red", "blue", "green", "yellow", "orange", "purple", "cyan", "pink"];

let tiles = [...colors, ...colors];
let firstTile = null;
let secondTile = null;
let lockBoard = false;
let remainingTurns = 10;
let streak = 0;
let orbCharge = 0;
let score = 0;
let gameEnded = true;
let playerName = "";
let successfulGames = 0;

nameInput.addEventListener("input", () => {
  playerName = nameInput.value.trim().slice(0, 12);
  startGameBtn.disabled = playerName === "";
});

startGameBtn.addEventListener("click", () => {
  playerName = nameInput.value.trim().slice(0, 12); // ensure playerName is set on start
  if (!playerName) return;
  
  gameEnded = false;
  namePrompt.style.display = "none";
  startGameBtn.style.display = "none";
  nameInput.disabled = true;
  generateTiles();
  updateTurns();
  updateOrb();
  updateScore();
  updateLeaderboard();
});

function updateTurns() {
  turnsDisplay.textContent = `Turns left: ${remainingTurns}`;
}

function updateScore() {
  scoreDisplay.textContent = `Score: ${score}`;
}

function updateOrb() {
  orb.className = "orb";
  if (orbCharge === 1) orb.classList.add("glow-1");
  else if (orbCharge === 2) orb.classList.add("glow-2");
  else if (orbCharge >= 3) orb.classList.add("glow-3");
}

function updateLeaderboard() {
  const playersRef = query(ref(db, "players"), orderByChild("score"), limitToLast(7));
  onValue(playersRef, snapshot => {
    const data = snapshot.val();
    if (!data) {
      leaderboard.innerHTML = "<strong>Leaderboard</strong><br>No players yet.";
      return;
    }
    const sorted = Object.values(data).sort((a, b) => b.score - a.score);
    leaderboard.innerHTML = `<strong>Leaderboard</strong><br>`;
    sorted.forEach(p => {
      const entry = document.createElement("div");
      entry.className = "entry";
      if (p.name === playerName) entry.classList.add("highlight");
      entry.textContent = `${p.name}: ${p.score}`;
      leaderboard.appendChild(entry);
    });
  });
}

async function saveScoreIfHigher() {
  if (!playerName) return;

  const playerRef = ref(db, "players/" + playerName);
  const snapshot = await get(playerRef);
  const existing = snapshot.val();
  if (!existing || score > existing.score) {
    await set(playerRef, {
      name: playerName,
      score: score
    });
  }
}

function endGame(message, won) {
  gameEnded = true;
  alert(message);
  if (won) {
    successfulGames++;
    orbCharge++;
    if (orbCharge >= 3) {
      score++;
      orbCharge = 0;
    }
    continueBtn.style.display = "inline-block";
    retryBtn.style.display = "none";
  } else {
    orbCharge = 0;
    successfulGames = 0;
    retryBtn.style.display = "inline-block";
    continueBtn.style.display = "none";
  }

  updateOrb();
  updateScore();
  saveScoreIfHigher();
}

function resetTiles() {
  [firstTile, secondTile] = [null, null];
  lockBoard = false;
}

function generateTiles() {
  gameGrid.innerHTML = "";
  tiles = [...colors, ...colors].sort(() => 0.5 - Math.random());
  tiles.forEach(color => {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.style.background = "#444"; // initial hidden color background
    tile.dataset.color = color;

    tile.addEventListener("click", () => {
      if (!playerName || lockBoard || tile.classList.contains("revealed") || tile === firstTile || remainingTurns <= 0 || gameEnded) return;
      tile.style.background = color;
      if (!firstTile) {
        firstTile = tile;
      } else {
        secondTile = tile;
        lockBoard = true;
        if (firstTile.dataset.color === secondTile.dataset.color) {
          firstTile.classList.add("revealed");
          secondTile.classList.add("revealed");
          streak++;
          if (remainingTurns > 5) remainingTurns--;
          updateTurns();
          resetTiles();
          if (document.querySelectorAll('.tile.revealed').length === tiles.length) {
            endGame("ðŸŽ‰ You matched all colors!", true);
          }
        } else {
          streak = 0;
          remainingTurns--;
          updateTurns();
          setTimeout(() => {
            firstTile.style.background = "#444";
            secondTile.style.background = "#444";
            resetTiles();
            if (remainingTurns <= 0) {
              endGame("Game Over! You ran out of turns.", false);
            }
          }, 800);
        }
      }
    });

    gameGrid.appendChild(tile);
  });
}

function restartGame(turns) {
  remainingTurns = turns;
  streak = 0;
  gameEnded = false;
  updateOrb();
  updateTurns();
  generateTiles();
  continueBtn.style.display = "none";
  retryBtn.style.display = "none";
}

continueBtn.addEventListener("click", () => {
  const newTurns = (successfulGames % 3 === 0 && successfulGames > 0) ? 5 : 10;
  restartGame(newTurns);
});

retryBtn.addEventListener("click", () => {
  restartGame(10);
});

// Initial leaderboard load
updateLeaderboard();
